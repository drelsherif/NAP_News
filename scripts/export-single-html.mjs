import fs from 'fs';
import path from 'path';

const root = process.cwd();
const distDir = path.join(root, 'dist');
const newsletterJsonPath = path.join(root, 'newsletter.json');

function findFirstAsset(ext) {
  const assetsDir = path.join(distDir, 'assets');
  const files = fs.readdirSync(assetsDir);
  const f = files.find(x => x.endsWith(ext));
  if (!f) throw new Error(`Could not find ${ext} in dist/assets`);
  return path.join(assetsDir, f);
}

if (!fs.existsSync(distDir)) {
  console.error('dist/ not found. Run: npm run build');
  process.exit(1);
}
if (!fs.existsSync(newsletterJsonPath)) {
  console.error('newsletter.json not found in project root. Export JSON from the app and rename it to newsletter.json.');
  process.exit(1);
}

const cssPath = findFirstAsset('.css');
const jsPath = findFirstAsset('.js');

const css = fs.readFileSync(cssPath, 'utf-8');
const js = fs.readFileSync(jsPath, 'utf-8');
const newsletter = fs.readFileSync(newsletterJsonPath, 'utf-8');

const EXTRA_SNIPPET = "\n\n<!-- FIX 1: Suppress \"Preview not available\" during newsletter.json load -->\n<script>\n(function() {\n  var SUPPRESS_TEXT = 'Preview not available';\n  var FADE_CSS = [\n    'position:fixed','inset:0','z-index:9999',\n    'background:rgba(3,8,15,0.92)','display:flex','align-items:center',\n    'justify-content:center','flex-direction:column','gap:12px',\n    'font-family:\"DM Sans\",system-ui,sans-serif','color:#fff'\n  ].join(';');\n\n  var overlay = null;\n\n  function showLoader() {\n    if (overlay) return;\n    overlay = document.createElement('div');\n    overlay.id = '__nap_loader';\n    overlay.style.cssText = FADE_CSS;\n    overlay.innerHTML = [\n      '<svg width=\"52\" height=\"52\" viewBox=\"0 0 64 64\" fill=\"none\" xmlns=\"http://www.w3.org/2000/svg\" style=\"animation:__napSpin 1.8s linear infinite\">',\n        '<defs>',\n          '<radialGradient id=\"__napG\" cx=\"50%\" cy=\"50%\" r=\"50%\">',\n            '<stop offset=\"0%\" stop-color=\"#009CDE\" stop-opacity=\"0.3\"/>',\n            '<stop offset=\"100%\" stop-color=\"#003087\" stop-opacity=\"0\"/>',\n          '</radialGradient>',\n        '</defs>',\n        '<circle cx=\"32\" cy=\"32\" r=\"28\" fill=\"url(#__napG)\" stroke=\"#009CDE\" stroke-width=\"0.5\" stroke-opacity=\"0.3\"/>',\n        '<path d=\"M24 20 L17 11 L11 11\" stroke=\"#0057A8\" stroke-width=\"1.3\" stroke-linecap=\"round\" stroke-linejoin=\"round\" fill=\"none\" opacity=\"0.7\"/>',\n        '<circle cx=\"11\" cy=\"11\" r=\"2.2\" fill=\"#009CDE\" opacity=\"0.7\"/>',\n        '<path d=\"M38 20 L45 11 L51 13\" stroke=\"#0057A8\" stroke-width=\"1.3\" stroke-linecap=\"round\" stroke-linejoin=\"round\" fill=\"none\" opacity=\"0.7\"/>',\n        '<path d=\"M43 30 L52 26 L58 19\" stroke=\"#0057A8\" stroke-width=\"1.2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" fill=\"none\" opacity=\"0.65\"/>',\n        '<path d=\"M39 44 L47 51 L53 53\" stroke=\"#0057A8\" stroke-width=\"1.2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" fill=\"none\" opacity=\"0.65\"/>',\n        '<path d=\"M21 32 L5 32\" stroke=\"#0057A8\" stroke-width=\"1.6\" stroke-linecap=\"round\" fill=\"none\" opacity=\"0.7\"/>',\n        '<path d=\"M5 32 L1 27 M5 32 L1 37\" stroke=\"#0057A8\" stroke-width=\"1\" stroke-linecap=\"round\" fill=\"none\" opacity=\"0.5\"/>',\n        '<circle cx=\"32\" cy=\"32\" r=\"13.5\" fill=\"#060D1E\" stroke=\"#009CDE\" stroke-width=\"1.3\"/>',\n        '<circle cx=\"32\" cy=\"32\" r=\"10\" fill=\"#0A1628\" stroke=\"#0057A8\" stroke-width=\"0.6\" opacity=\"0.8\"/>',\n        '<path d=\"M8 32 L18 32 L21 32 L23 26 L25.5 38 L28 23 L30 41 L32 27.5 L34 36 L36 30.5 L38.5 32 L41 32 L56 32\"',\n          ' stroke=\"#009CDE\" stroke-width=\"1.8\" stroke-linecap=\"round\" stroke-linejoin=\"round\" fill=\"none\" opacity=\"0.25\"/>',\n        '<path id=\"__napWave\" d=\"M8 32 L18 32 L21 32 L23 26 L25.5 38 L28 23 L30 41 L32 27.5 L34 36 L36 30.5 L38.5 32 L41 32 L56 32\"',\n          ' stroke=\"#00E5FF\" stroke-width=\"2.2\" stroke-linecap=\"round\" stroke-linejoin=\"round\" fill=\"none\"',\n          ' style=\"stroke-dasharray:220;stroke-dashoffset:220;animation:__napEEG 2.8s ease-in-out infinite\"/>',\n        '<circle cx=\"32\" cy=\"32\" r=\"3.5\" fill=\"#009CDE\" style=\"animation:__napPulse 2.8s ease-in-out infinite\"/>',\n      '</svg>',\n      '<style>',\n        '@keyframes __napSpin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}',\n        '@keyframes __napEEG{0%{stroke-dashoffset:220;opacity:0}10%{opacity:1}80%{opacity:1}100%{stroke-dashoffset:0;opacity:0.4}}',\n        '@keyframes __napPulse{0%,100%{r:3.5;opacity:0.8}50%{r:5;opacity:1}}',\n      '</style>',\n      '<div style=\"font-family:\\'DM Serif Display\\',serif;font-size:1.3rem;color:#fff;letter-spacing:-0.01em\">The Neurology AI Pulse</div>',\n      '<div style=\"font-family:\\'DM Mono\\',monospace;font-size:0.55rem;letter-spacing:0.22em;text-transform:uppercase;color:rgba(255,255,255,0.35)\">Loading issue&hellip;</div>'\n    ].join('');\n    document.body.appendChild(overlay);\n  }\n\n  function hideLoader() {\n    if (!overlay) return;\n    overlay.style.transition = 'opacity 0.4s ease';\n    overlay.style.opacity = '0';\n    setTimeout(function() { if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay); overlay = null; }, 420);\n  }\n\n  // Watch for the \"Preview not available\" text and hide it while the loader is shown\n  var obs = new MutationObserver(function() {\n    var all = document.querySelectorAll('*');\n    for (var i = 0; i < all.length; i++) {\n      var el = all[i];\n      if (el.children.length === 0 && el.textContent && el.textContent.trim() === SUPPRESS_TEXT) {\n        // Found it \u2014 this is the loading state, keep loader visible and hide this element\n        el.style.display = 'none';\n        showLoader();\n        return;\n      }\n    }\n    // \"Preview not available\" text not found \u2014 content is rendered, hide loader\n    hideLoader();\n    obs.disconnect();\n  });\n\n  // Show loader immediately and start observing\n  document.addEventListener('DOMContentLoaded', function() {\n    showLoader();\n    obs.observe(document.body, { childList: true, subtree: true, characterData: true });\n    // Safety timeout \u2014 always hide after 8 seconds regardless\n    setTimeout(hideLoader, 8000);\n  });\n})();\n</script>\n\n<!-- FIX 2: RSS Live Feed v6 \u2014 hides native scroll, injects clean panel below native header -->\n<style>\n/* Hide the native article scroll area; keep the native header bar intact */\n.nap-rss-sidebar .nap-rss-scroll { display: none !important; }\n/* Hide the native config <details> \u2014 we replace it with our own controls */\n.nap-rss-sidebar .nap-rss-config { display: none !important; }\n/* Hover state for article rows */\n.nap6-row:hover { background: rgba(0,87,168,0.04) !important; }\n.nap6-link:hover { color: #003087 !important; }\n/* Loader spin */\n@keyframes nap6spin { to { transform: rotate(360deg); } }\n</style>\n<script>\n(function() {\n  var STORAGE_KEY  = 'nap_live_rss_v6';\n  var PROXY        = 'https://api.allorigins.win/get?url=';\n  var PRESETS = [\n    { label: 'Frontiers in Neuroscience',  url: 'https://www.frontiersin.org/journals/neuroscience/rss' },\n    { label: 'Frontiers in Neurology',     url: 'https://www.frontiersin.org/journals/neurology/rss' },\n    { label: 'MIT News \u2014 AI',              url: 'https://news.mit.edu/rss/topic/artificial-intelligence2' },\n    { label: 'ScienceDaily \u2014 AI',          url: 'https://www.sciencedaily.com/rss/computers_math/artificial_intelligence.xml' },\n    { label: 'MarkTechPost',               url: 'https://www.marktechpost.com/feed/' },\n    { label: 'The Lancet Neurology',       url: 'https://www.thelancet.com/rssfeed/laneur_current.xml' },\n    { label: 'JAMA Neurology',             url: 'https://jamanetwork.com/rss/site_16/0.xml' },\n    { label: 'npj Digital Medicine',       url: 'https://www.nature.com/npjdigitalmed.rss' },\n    { label: 'PubMed Neurology AI',        url: 'https://pubmed.ncbi.nlm.nih.gov/rss/search/1x9bY_ZPGMIgWOrGWvQbkjt2X1J5zCH66gaj5UHwPTuOP_TklI/?limit=15&utm_campaign=pubmed-2&fc=20260222062849' }\n  ];\n\n  /* \u2500\u2500 Helpers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n  function clamp(v, mn, mx, d) { var n = Number(v); return isFinite(n) ? Math.min(mx, Math.max(mn, Math.round(n))) : d; }\n  function uniq(arr) { var s = {}, o = []; arr.forEach(function(x){ var u = String(x||'').trim(); if(u && !s[u]){ s[u]=1; o.push(u); } }); return o; }\n  function isUrl(u) { try { new URL(u); return true; } catch(e) { return false; } }\n  function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;'); }\n  function fmtDate(d) { try { return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}); } catch(e){ return ''; } }\n\n  /* \u2500\u2500 State \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n  function loadState() {\n    try {\n      var st = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');\n      return {\n        live:         !!st.live,\n        visible:      st.visible !== false,\n        maxFeeds:     clamp(st.maxFeeds, 1, 9, 5),\n        itemsPerFeed: clamp(st.itemsPerFeed, 3, 30, 10),\n        totalItems:   clamp(st.totalItems, 5, 200, 20),\n        selected:     Array.isArray(st.selected) ? st.selected.filter(Boolean) : PRESETS.map(function(p){return p.url;}),\n        custom:       Array.isArray(st.custom)   ? st.custom.filter(Boolean)   : []\n      };\n    } catch(e) {\n      return { live:false, visible:true, maxFeeds:5, itemsPerFeed:10, totalItems:20, selected:PRESETS.map(function(p){return p.url;}), custom:[] };\n    }\n  }\n  function saveState(st) { localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }\n\n  /* \u2500\u2500 Session cache \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n  function cacheKey(st) {\n    var s = st.selected.slice().sort().join('|') + '::' + st.maxFeeds + '::' + st.itemsPerFeed + '::' + (st.totalItems||'');\n    var h = 0; for(var i=0;i<s.length;i++) h = ((h * 31) + s.charCodeAt(i)) | 0;\n    return 'nap6_c_' + Math.abs(h);\n  }\n  function readCache(key) {\n    try {\n      var o = JSON.parse(sessionStorage.getItem(key) || 'null');\n      if (!o || !o.ts || Date.now() - o.ts > 3600000) { sessionStorage.removeItem(key); return null; }\n      return o.d;\n    } catch(e) { return null; }\n  }\n  function writeCache(key, d) { try { sessionStorage.setItem(key, JSON.stringify({ts:Date.now(), d:d})); } catch(e){} }\n  function clearCacheKey(key) { try { sessionStorage.removeItem(key); } catch(e){} }\n\n  /* \u2500\u2500 RSS fetch \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n  function parseRss(xml, fallback) {\n    try {\n      var doc = new DOMParser().parseFromString(xml, 'text/xml');\n      if (doc.querySelector('parsererror')) return [];\n      var ch = (doc.querySelector('channel > title') || {textContent:''}).textContent.trim() || fallback;\n      return Array.from(doc.querySelectorAll('item')).map(function(it) {\n        return {\n          title:   ((it.querySelector('title')||{}).textContent||'').trim(),\n          url:     ((it.querySelector('link')||{}).textContent||'').trim(),\n          source:  ch,\n          pubDate: ((it.querySelector('pubDate')||{}).textContent||'').trim()\n        };\n      }).filter(function(x){ return x.title || x.url; });\n    } catch(e) { return []; }\n  }\n  function fetchFeed(url) {\n    return fetch(PROXY + encodeURIComponent(url))\n      .then(function(r){ return r.json(); })\n      .then(function(d){ return parseRss(typeof d.contents === 'string' ? d.contents : '', url); });\n  }\n\n  /* \u2500\u2500 DOM helpers \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n  function el(tag, css, attrs) {\n    var e = document.createElement(tag);\n    if (css) e.style.cssText = css;\n    if (attrs) Object.keys(attrs).forEach(function(k){ e.setAttribute(k, attrs[k]); });\n    return e;\n  }\n  function btn(text, primary) {\n    var b = el('button', [\n      'padding:5px 14px',\n      'border-radius:99px',\n      'font-family:DM Sans,system-ui,sans-serif',\n      'font-size:0.62rem',\n      'font-weight:700',\n      'letter-spacing:0.04em',\n      'cursor:pointer',\n      'transition:background 0.15s,color 0.15s,border-color 0.15s',\n      primary\n        ? 'background:#003087;color:#fff;border:none'\n        : 'background:#fff;color:#003087;border:1px solid rgba(0,87,168,0.3)'\n    ].join(';'));\n    b.textContent = text;\n    return b;\n  }\n\n  /* \u2500\u2500 Build panel \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n  function buildPanel(sidebar) {\n    if (sidebar.querySelector('[data-nap6]')) return;\n    var st = loadState();\n\n    /* \u2500\u2500 wrapper \u2500\u2500 */\n    var wrap = el('div', 'font-family:DM Sans,system-ui,sans-serif;', {'data-nap6':'1'});\n\n    /* \u2500\u2500 control bar \u2500\u2500 */\n    var bar = el('div', [\n      'display:flex',\n      'align-items:center',\n      'gap:8px',\n      'flex-wrap:wrap',\n      'padding:10px 16px',\n      'background:rgba(0,48,135,0.05)',\n      'border-top:1px solid rgba(0,87,168,0.12)'\n    ].join(';'));\n\n    // Status dot + label\n    var dotWrap = el('div', 'display:flex;align-items:center;gap:6px;flex:1;min-width:0');\n    var dot = el('span', 'display:inline-block;width:8px;height:8px;border-radius:50%;background:#94A3B8;transition:background 0.3s,box-shadow 0.3s;flex-shrink:0');\n    var dotLabel = el('span', 'font-size:0.58rem;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;color:#5A789A');\n    dotLabel.textContent = 'Off';\n    var cachedBadge = el('span', 'display:none;font-size:0.48rem;letter-spacing:0.12em;color:#8FA8C0;border:1px solid #C8D9EE;border-radius:99px;padding:1px 7px;margin-left:2px');\n    cachedBadge.textContent = 'session';\n    dotWrap.appendChild(dot);\n    dotWrap.appendChild(dotLabel);\n    dotWrap.appendChild(cachedBadge);\n\n    var btnReload = btn('\u21ba Reload', false);\n    var btnSrc    = btn('\u2699 Sources', false);\n    var btnToggle = btn('Hide Feed', true);\n\n    bar.appendChild(dotWrap);\n    bar.appendChild(btnReload);\n    bar.appendChild(btnSrc);\n    bar.appendChild(btnToggle);\n    wrap.appendChild(bar);\n\n    /* \u2500\u2500 sources panel \u2500\u2500 */\n    var srcPanel = el('div', [\n      'display:none',\n      'padding:14px 16px',\n      'background:#F8FAFD',\n      'border-top:1px solid rgba(0,87,168,0.1)'\n    ].join(';'));\n\n    // Explainer\n    var expEl = el('p', 'font-size:0.68rem;line-height:1.7;color:#3D5878;margin:0 0 12px');\n    expEl.innerHTML = 'Articles are fetched live from curated neurology &amp; AI research RSS feeds &mdash; <em>Frontiers in Neurology</em>, <em>The Lancet Neurology</em>, <em>JAMA Neurology</em>, <em>npj Digital Medicine</em>, <em>ScienceDaily AI</em>, MIT News, and PubMed. Articles are cached for the session so the same visit always shows the same set. Click <strong>\u21ba Reload</strong> to fetch fresh content.';\n    srcPanel.appendChild(expEl);\n\n    // Row 1: live toggle + selects\n    var row1 = el('div', 'display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px');\n\n    var liveLabel = document.createElement('label');\n    liveLabel.style.cssText = 'display:flex;align-items:center;gap:6px;font-size:0.68rem;font-weight:700;color:#003087;cursor:pointer';\n    var liveChk = el('input', 'accent-color:#003087;width:14px;height:14px');\n    liveChk.type = 'checkbox';\n    liveChk.checked = st.live;\n    liveLabel.appendChild(liveChk);\n    liveLabel.appendChild(document.createTextNode(' Live RSS'));\n\n    function mkSelectLabel(text, opts, val) {\n      var lbl = document.createElement('label');\n      lbl.style.cssText = 'display:flex;align-items:center;gap:5px;font-size:0.65rem;color:#3D5878';\n      lbl.appendChild(document.createTextNode(text + ' '));\n      var sel = document.createElement('select');\n      sel.style.cssText = 'padding:3px 6px;border-radius:6px;border:1px solid rgba(0,87,168,0.2);background:#fff;font-size:0.65rem;color:#1A2B4A';\n      opts.forEach(function(v) {\n        var o = document.createElement('option');\n        o.value = String(v); o.textContent = String(v);\n        if (v == val) o.selected = true;\n        sel.appendChild(o);\n      });\n      lbl.appendChild(sel);\n      return { lbl:lbl, sel:sel };\n    }\n\n    var mf = mkSelectLabel('Max feeds', [1,2,3,4,5,6,7,8,9], st.maxFeeds);\n    var mi = mkSelectLabel('Per feed', [3,5,8,10,15,20,30], st.itemsPerFeed);\n    var mt = mkSelectLabel('Total', [5,10,15,20], st.totalItems || 20);\n    row1.appendChild(liveLabel);\n    row1.appendChild(mf.lbl);\n    row1.appendChild(mi.lbl);\n    srcPanel.appendChild(row1);\n\n    // Feed list\n    var feedListEl = el('div', 'max-height:190px;overflow-y:auto;border:1px solid rgba(0,87,168,0.12);border-radius:8px;background:#fff;margin-bottom:10px');\n    srcPanel.appendChild(feedListEl);\n\n    // Add URL row\n    var addRow = el('div', 'display:flex;gap:8px;margin-bottom:8px');\n    var urlInput = el('input', 'flex:1;min-width:0;padding:6px 10px;border-radius:8px;border:1px solid rgba(0,87,168,0.2);font-family:DM Mono,ui-monospace,monospace;font-size:0.6rem;color:#1A2B4A');\n    urlInput.placeholder = 'Paste RSS URL to add\u2026';\n    var btnAdd = btn('Add', false);\n    btnAdd.style.borderRadius = '8px';\n    addRow.appendChild(urlInput);\n    addRow.appendChild(btnAdd);\n    srcPanel.appendChild(addRow);\n\n    var srcStatus = el('div', 'font-size:0.58rem;color:#5A789A;min-height:14px');\n    srcPanel.appendChild(srcStatus);\n    wrap.appendChild(srcPanel);\n\n    /* \u2500\u2500 feed container \u2500\u2500 */\n    var feedEl = el('div', 'background:#fff');\n    wrap.appendChild(feedEl);\n\n    // Insert wrap right after the native header bar (first child of sidebar)\n    var firstChild = sidebar.firstElementChild;\n    if (firstChild && firstChild.nextSibling) {\n      sidebar.insertBefore(wrap, firstChild.nextSibling);\n    } else {\n      sidebar.appendChild(wrap);\n    }\n\n    /* \u2500\u2500 Status updater \u2500\u2500 */\n    var STATUS = {\n      live:    { color:'#22C55E', shadow:'0 0 0 3px rgba(34,197,94,0.25)',   label:'Live' },\n      cached:  { color:'#22C55E', shadow:'0 0 0 3px rgba(34,197,94,0.15)',   label:'Live (session)' },\n      loading: { color:'#F59E0B', shadow:'0 0 0 3px rgba(245,158,11,0.25)',  label:'Loading\u2026' },\n      off:     { color:'#94A3B8', shadow:'none',                              label:'Off' },\n      error:   { color:'#EF4444', shadow:'0 0 0 3px rgba(239,68,68,0.25)',   label:'Error' }\n    };\n    function setDot(key) {\n      var s = STATUS[key] || STATUS.off;\n      dot.style.background = s.color;\n      dot.style.boxShadow  = s.shadow;\n      dotLabel.textContent = s.label;\n      dotLabel.style.color = (key === 'off') ? '#5A789A' : s.color;\n      cachedBadge.style.display = (key === 'cached') ? 'inline' : 'none';\n    }\n\n    /* \u2500\u2500 Feed list render \u2500\u2500 */\n    var customFeeds = JSON.parse(localStorage.getItem('nap6_custom') || '[]');\n    function saveCustom() { localStorage.setItem('nap6_custom', JSON.stringify(customFeeds)); }\n\n    function renderFeedList() {\n      var selected = {};\n      (st.selected || []).forEach(function(u){ selected[u] = true; });\n      var all = PRESETS.map(function(p){ return {label:p.label, url:p.url, custom:false}; })\n                      .concat(customFeeds.map(function(u){ return {label:u, url:u, custom:true}; }));\n      while (feedListEl.firstChild) feedListEl.removeChild(feedListEl.firstChild);\n      all.forEach(function(p) {\n        var row = document.createElement('label');\n        row.style.cssText = 'display:flex;align-items:flex-start;gap:8px;padding:6px 10px;border-bottom:1px solid rgba(0,87,168,0.07);cursor:pointer';\n\n        var chk = el('input');\n        chk.type = 'checkbox';\n        chk.checked = !!selected[p.url];\n        chk.setAttribute('data-url', p.url);\n        chk.style.cssText = 'margin-top:2px;accent-color:#003087;flex-shrink:0';\n\n        var info = el('div', 'flex:1;min-width:0');\n        var nm = el('div', 'font-size:0.66rem;font-weight:600;color:#1A2B4A;margin-bottom:1px');\n        nm.textContent = p.label;\n        var ur = el('div', 'font-family:DM Mono,ui-monospace,monospace;font-size:0.48rem;color:#8FA8C0;word-break:break-all');\n        ur.textContent = p.url;\n        info.appendChild(nm);\n        info.appendChild(ur);\n\n        row.appendChild(chk);\n        row.appendChild(info);\n\n        if (p.custom) {\n          var rmBtn = el('button', 'border:none;background:transparent;color:#EF4444;cursor:pointer;font-size:13px;flex-shrink:0;padding:0 2px;line-height:1');\n          rmBtn.textContent = '\u00d7';\n          rmBtn.setAttribute('data-rm', p.url);\n          row.appendChild(rmBtn);\n        }\n        feedListEl.appendChild(row);\n      });\n    }\n\n    function syncFeeds() {\n      var boxes = feedListEl.querySelectorAll('input[type=\"checkbox\"][data-url]');\n      st.selected = uniq(Array.from(boxes).filter(function(b){ return b.checked; }).map(function(b){ return b.getAttribute('data-url'); }));\n      saveState(st);\n    }\n\n    feedListEl.addEventListener('change', function(e) {\n      if (e.target.type === 'checkbox' && e.target.hasAttribute('data-url')) syncFeeds();\n    });\n    feedListEl.addEventListener('click', function(e) {\n      var url = e.target.getAttribute && e.target.getAttribute('data-rm');\n      if (!url) return;\n      var i = customFeeds.indexOf(url);\n      if (i !== -1) { customFeeds.splice(i,1); saveCustom(); }\n      st.selected = st.selected.filter(function(u){ return u !== url; });\n      saveState(st);\n      renderFeedList();\n      srcStatus.textContent = 'Removed.';\n    });\n\n    function addUrl() {\n      var u = (urlInput.value || '').trim();\n      if (!u) return;\n      if (!isUrl(u)) { srcStatus.textContent = 'Invalid URL.'; return; }\n      if (customFeeds.indexOf(u) === -1) { customFeeds.push(u); saveCustom(); }\n      if (st.selected.indexOf(u) === -1) st.selected.push(u);\n      saveState(st);\n      urlInput.value = '';\n      renderFeedList();\n      srcStatus.textContent = 'Added.';\n    }\n    btnAdd.addEventListener('click', addUrl);\n    urlInput.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); addUrl(); } });\n\n    mf.sel.addEventListener('change', function(){ st.maxFeeds = clamp(mf.sel.value,1,9,5); saveState(st); });\n    mi.sel.addEventListener('change', function(){ st.itemsPerFeed = clamp(mi.sel.value,3,30,10); saveState(st); });\n    mt.sel.addEventListener('change', function(){ st.totalItems = clamp(mt.sel.value,5,200,20); saveState(st); });\n\n    liveChk.addEventListener('change', function() {\n      st.live = liveChk.checked;\n      saveState(st);\n      if (st.live) { doLoad(false); }\n      else {\n        setDot('off');\n        while (feedEl.firstChild) feedEl.removeChild(feedEl.firstChild);\n        var msg = el('div', 'padding:20px 16px;text-align:center;font-size:0.72rem;color:#5A789A');\n        msg.innerHTML = 'Enable <strong>Live RSS</strong> in \u2699 Sources to load articles.';\n        feedEl.appendChild(msg);\n      }\n    });\n\n    /* \u2500\u2500 Article render \u2500\u2500 */\n    function renderItems(items, fromCache) {\n      while (feedEl.firstChild) feedEl.removeChild(feedEl.firstChild);\n      if (!items || !items.length) {\n        var msg = el('div', 'padding:24px 16px;text-align:center;font-size:0.72rem;color:#5A789A');\n        msg.textContent = 'No articles found.';\n        feedEl.appendChild(msg);\n        return;\n      }\n      items.forEach(function(it, i) {\n        var row = el('div', 'display:flex;gap:12px;align-items:flex-start;padding:11px 16px;border-bottom:1px solid rgba(0,87,168,0.08)');\n        row.className = 'nap6-row';\n\n        var num = el('span', 'font-family:DM Mono,ui-monospace,monospace;font-size:0.6rem;color:#009CDE;flex-shrink:0;min-width:20px;font-weight:600;padding-top:1px');\n        num.textContent = String(i+1).padStart(2,'0');\n\n        var body = el('div', 'flex:1;min-width:0');\n\n        var titleDiv = el('div', 'font-size:0.8rem;font-weight:600;color:#1A2B4A;line-height:1.35;margin-bottom:3px');\n        if (it.url) {\n          var a = document.createElement('a');\n          a.href = it.url; a.target = '_blank'; a.rel = 'noopener';\n          a.className = 'nap6-link';\n          a.style.cssText = 'color:#1A2B4A;text-decoration:none';\n          a.textContent = it.title;\n          titleDiv.appendChild(a);\n        } else {\n          titleDiv.textContent = it.title;\n        }\n\n        var meta = el('div', 'display:flex;gap:8px;align-items:center;flex-wrap:wrap');\n        if (it.source) {\n          var src = el('span', 'font-family:DM Mono,ui-monospace,monospace;font-size:0.48rem;text-transform:uppercase;letter-spacing:0.1em;color:#5A789A');\n          src.textContent = it.source;\n          meta.appendChild(src);\n        }\n        if (it.pubDate) {\n          var dt = el('span', 'font-family:DM Mono,ui-monospace,monospace;font-size:0.48rem;color:#8FA8C0');\n          dt.textContent = fmtDate(it.pubDate);\n          meta.appendChild(dt);\n        }\n\n        body.appendChild(titleDiv);\n        body.appendChild(meta);\n        row.appendChild(num);\n        row.appendChild(body);\n\n        if (it.url) {\n          var ext = document.createElement('a');\n          ext.href = it.url; ext.target = '_blank'; ext.rel = 'noopener';\n          ext.style.cssText = 'color:#009CDE;font-size:0.75rem;flex-shrink:0;text-decoration:none;font-weight:700;opacity:0.7;padding-top:1px;transition:opacity 0.15s';\n          ext.textContent = '\u2197';\n          ext.addEventListener('mouseenter', function(){ this.style.opacity='1'; });\n          ext.addEventListener('mouseleave', function(){ this.style.opacity='0.7'; });\n          row.appendChild(ext);\n        }\n        feedEl.appendChild(row);\n      });\n\n      // Cache note at bottom\n      if (fromCache) {\n        var note = el('div', 'padding:8px 16px;font-family:DM Mono,ui-monospace,monospace;font-size:0.48rem;letter-spacing:0.08em;color:#8FA8C0;border-top:1px solid rgba(0,87,168,0.06)');\n        note.textContent = items.length + ' articles \u00b7 session cache \u2014 click \u21ba Reload to fetch fresh';\n        feedEl.appendChild(note);\n      } else {\n        var note2 = el('div', 'padding:8px 16px;font-family:DM Mono,ui-monospace,monospace;font-size:0.48rem;letter-spacing:0.08em;color:#8FA8C0;border-top:1px solid rgba(0,87,168,0.06)');\n        note2.textContent = items.length + ' articles from ' + Math.min(st.selected.length, st.maxFeeds) + ' feeds \u00b7 live';\n        feedEl.appendChild(note2);\n      }\n    }\n\n    /* \u2500\u2500 Core load \u2500\u2500 */\n    function doLoad(force) {\n      if (!st.live) { setDot('off'); return; }\n      var feeds = st.selected.slice(0, st.maxFeeds);\n      if (!feeds.length) { setDot('error'); return; }\n      var key = cacheKey(st);\n      if (!force) {\n        var cached = readCache(key);\n        if (cached && cached.length) { renderItems(cached, true); setDot('cached'); return; }\n      }\n      // Live fetch\n      setDot('loading');\n      while (feedEl.firstChild) feedEl.removeChild(feedEl.firstChild);\n      var spinner = el('div', 'display:flex;align-items:center;gap:10px;padding:24px 16px;font-family:DM Mono,ui-monospace,monospace;font-size:0.6rem;color:#5A789A');\n      var svg = document.createElementNS('http://www.w3.org/2000/svg','svg');\n      svg.setAttribute('width','14'); svg.setAttribute('height','14'); svg.setAttribute('viewBox','0 0 24 24');\n      svg.setAttribute('fill','none'); svg.setAttribute('stroke','currentColor'); svg.setAttribute('stroke-width','2');\n      svg.style.cssText = 'animation:nap6spin 0.8s linear infinite;flex-shrink:0';\n      svg.innerHTML = '<path d=\"M23 4v6h-6M1 20v-6h6\"/><path d=\"M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15\"/>';\n      spinner.appendChild(svg);\n      spinner.appendChild(document.createTextNode('Fetching from ' + feeds.length + ' feed' + (feeds.length>1?'s':'') + '\u2026'));\n      feedEl.appendChild(spinner);\n\n      Promise.all(feeds.map(function(url){\n        return fetchFeed(url).then(function(items){ return items.slice(0, st.itemsPerFeed); }).catch(function(){ return []; });\n      })).then(function(results) {\n        var all = [];\n        results.forEach(function(r){ all = all.concat(r); });\n        var seen = {}, deduped = [];\n        all.forEach(function(it){\n          var k = it.url || (it.source + '::' + it.title);\n          if (!k || seen[k]) return;\n          seen[k] = 1; deduped.push(it);\n        });\n        deduped.sort(function(a,b){ return (Date.parse(b.pubDate)||0)-(Date.parse(a.pubDate)||0); });\n        var limit = st.totalItems ? clamp(st.totalItems,5,200,20) : Math.min(200, st.maxFeeds * st.itemsPerFeed);\n        var final = deduped.slice(0, limit);\n        writeCache(key, final);\n        renderItems(final, false);\n        setDot(final.length ? 'live' : 'error');\n      }).catch(function(){ setDot('error'); });\n    }\n\n    /* \u2500\u2500 Button wiring \u2500\u2500 */\n    btnSrc.addEventListener('click', function() {\n      var open = srcPanel.style.display !== 'none';\n      srcPanel.style.display = open ? 'none' : 'block';\n      btnSrc.style.background = open ? '#fff' : '#003087';\n      btnSrc.style.color      = open ? '#003087' : '#fff';\n      btnSrc.style.borderColor = open ? 'rgba(0,87,168,0.3)' : 'transparent';\n      if (!open) { renderFeedList(); }\n    });\n\n    btnReload.addEventListener('click', function() {\n      clearCacheKey(cacheKey(st));\n      if (!st.live) {\n        srcPanel.style.display = 'block';\n        btnSrc.style.background = '#003087';\n        btnSrc.style.color = '#fff';\n        renderFeedList();\n        srcStatus.textContent = 'Enable Live RSS then reload.';\n        return;\n      }\n      doLoad(true);\n    });\n\n    var feedVisible = st.visible;\n    function applyVisibility() {\n      feedEl.style.display = feedVisible ? '' : 'none';\n      btnToggle.textContent = feedVisible ? 'Hide Feed' : 'Show Feed';\n      btnToggle.style.background = feedVisible ? '#003087' : '#fff';\n      btnToggle.style.color      = feedVisible ? '#fff'    : '#003087';\n      btnToggle.style.border     = feedVisible ? 'none'    : '1px solid rgba(0,87,168,0.3)';\n    }\n\n    btnToggle.addEventListener('click', function() {\n      feedVisible = !feedVisible;\n      st.visible = feedVisible;\n      saveState(st);\n      applyVisibility();\n    });\n\n    /* \u2500\u2500 Init \u2500\u2500 */\n    renderFeedList();\n    applyVisibility();\n    if (st.live && st.visible) {\n      doLoad(false);\n    } else if (!st.live) {\n      setDot('off');\n      if (st.visible) {\n        var msg = el('div', 'padding:20px 16px;text-align:center;font-size:0.72rem;color:#5A789A');\n        msg.innerHTML = 'Enable <strong>Live RSS</strong> in \u2699 Sources to load articles.';\n        feedEl.appendChild(msg);\n      }\n    }\n  }\n\n  /* \u2500\u2500 Boot loop \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500 */\n  var tries = 0;\n  var timer = setInterval(function() {\n    tries++;\n    var sidebars = document.querySelectorAll('.nap-rss-sidebar:not([data-nap6])');\n    if (sidebars.length) {\n      sidebars.forEach(function(sb){ sb.setAttribute('data-nap6','1'); buildPanel(sb); });\n      clearInterval(timer);\n    } else if (tries > 80) {\n      clearInterval(timer);\n    }\n  }, 300);\n})();\n\n\n";

const out = `<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Neurology AI Pulse — Single File Export</title>
<style>${css}</style>
</head>
<body>
<div id="root"></div>
<script>
  window.__NAP_NEWSLETTER__ = ${newsletter};
  location.hash = "#/preview";
</script>
<script type="module">
${js}
</script>
${EXTRA_SNIPPET}
</body>
</html>`;

fs.writeFileSync(path.join(root, 'export_single.html'), out, 'utf-8');
console.log('✅ export_single.html created (open in browser).');
console.log('⚠️ Email clients often block scripts. This is for attaching/sharing as a file, not pasting into an email body.');
